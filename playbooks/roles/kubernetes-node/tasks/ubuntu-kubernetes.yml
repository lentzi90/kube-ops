- name: Install commonly needed packages
  apt:
    name:
      - nfs-common
      - apt-transport-https

- name: Fix DNS on ubuntu bionic
  when: ansible_distribution_release == 'bionic'
  block:
    - name: Use google nameservers
      lineinfile:
        destfile: /etc/netplan/01-netcfg.yaml
        regexp: '^(\s+addresses:\s)(.*)$'
        line: '\1[8.8.8.8, 8.8.4.4]'
        backrefs: yes
      register: netplan_config
    - name: Apply DNS config
      command: netplan apply
      when: netplan_config is changed

- name: Install docker
  apt:
    name: docker.io
    update_cache: yes

- name: Add kubernetes apt key
  apt_key:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg

- name: Add kubernetes repository
  apt_repository:
    repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
  register: kubernetes_repo

- name: Update apt cache
  apt:
    update_cache: yes
  when: kubernetes_repo is changed

- name: Install kubernetes parts
  apt:
    name:
      - kubelet={{ k8s_version }}-00
      - kubeadm={{ k8s_version }}-00
      - kubectl={{ k8s_version }}-00
    state: present
